<!DOCTYPE html>
<html>

<head>
    <title>Speedtest</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        button {
            padding: 10px 15px;
            font-size: 16px;
        }

        #results {
            margin-top: 20px;
            white-space: pre-line;
        }
    </style>
</head>

<body>
    <button onclick="runSpeedTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏</button>
    <div id="results"></div>

    <script>
        async function runSpeedTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "üîÑ –ò–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏... (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)";

            // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Å GitHub (–±–æ–ª—å—à–∏–µ –±–∏–Ω–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã)
            const testFiles = [
                "https://raw.githubusercontent.com/pacexy/speedtest/master/10mb.bin",
                "https://raw.githubusercontent.com/pacexy/speedtest/master/20mb.bin",
                "https://raw.githubusercontent.com/pacexy/speedtest/master/50mb.bin"
            ];

            // –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (3 –∑–∞–º–µ—Ä–∞)
            let downloadSpeeds = [];
            for (let i = 0; i < 3; i++) {
                const fileUrl = testFiles[i % testFiles.length] + "?rand=" + Math.random();
                try {
                    const speed = await measureDownloadSpeed(fileUrl);
                    downloadSpeeds.push(speed);
                    resultsDiv.innerHTML += `\n–ó–∞–≥—Ä—É–∑–∫–∞ ${i + 1}: ${speed.toFixed(2)} –ú–±–∏—Ç/—Å`;
                } catch (error) {
                    resultsDiv.innerHTML += `\n–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ—Ä–µ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`;
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // –¢–µ—Å—Ç –æ—Ç–¥–∞—á–∏ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π)
            const uploadSpeed = await measureUploadSpeed();
            resultsDiv.innerHTML += `\n–û—Ç–¥–∞—á–∞: ${uploadSpeed.toFixed(2)} –ú–±–∏—Ç/—Å`;

            // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const maxDownload = Math.max(...downloadSpeeds);
            const minDownload = Math.min(...downloadSpeeds);
            const avgDownload = downloadSpeeds.reduce((a, b) => a + b, 0) / downloadSpeeds.length;

            resultsDiv.innerHTML += `
                \n\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
                \n–ú–∞–∫—Å. —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: ${maxDownload.toFixed(2)} –ú–±–∏—Ç/—Å
                \n–ú–∏–Ω. —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: ${minDownload.toFixed(2)} –ú–±–∏—Ç/—Å
                \n–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: ${avgDownload.toFixed(2)} –ú–±–∏—Ç/—Å
                \n–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–¥–∞—á–∏: ${uploadSpeed.toFixed(2)} –ú–±–∏—Ç/—Å
            `;
        }

        // –ó–∞–º–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        async function measureDownloadSpeed(url) {
            const startTime = performance.now();
            const response = await fetch(url, { cache: "no-store" });
            if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª");
            const blob = await response.blob();
            const endTime = performance.now();

            // –†–∞–∑–º–µ—Ä –≤ –±–∏—Ç–∞—Ö / –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö ‚Üí –ú–±–∏—Ç/—Å
            const fileSizeBits = blob.size * 8;
            const durationSeconds = (endTime - startTime) / 1000;
            return fileSizeBits / durationSeconds / 1_000_000;
        }

        // –ó–∞–º–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–¥–∞—á–∏ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π, —á–µ—Ä–µ–∑ WebSocket)
        async function measureUploadSpeed() {
            return new Promise((resolve) => {
                const socket = new WebSocket("wss://echo.websocket.org");
                const testData = new Uint8Array(1 * 1024 * 1024); // 1 MB
                let startTime;

                socket.onopen = () => {
                    startTime = performance.now();
                    socket.send(testData);
                };

                socket.onmessage = () => {
                    const endTime = performance.now();
                    socket.close();
                    const durationSeconds = (endTime - startTime) / 1000;
                    const speed = (1 * 8) / durationSeconds; // –ú–±–∏—Ç/—Å
                    resolve(speed);
                };

                socket.onerror = () => resolve(0);
            });
        }
    </script>
</body>

</html>
